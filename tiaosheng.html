<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI跳绳计数器检测原理</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            background: #1a1a2e;
            color: white;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 1000px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        
        .content {
            display: flex;
            gap: 30px;
            width: 100%;
        }
        
        .left-panel {
        
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
   
        .camera-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            border-radius: 10px;
            overflow: hidden;
            background: #000;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }
        
        #output {
            width: 100%;
            display: block;
        }
        
        #webcam {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }
        
        .counter {
            font-size: 5rem;
            font-weight: bold;
            color: #4cc9f0;
            text-shadow: 0 0 10px rgba(76, 201, 240, 0.5);
            text-align: center;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        #startBtn {
            background: #4CAF50;
            color: white;
        }
        
        #startBtn:hover {
            background: #45a049;
        }
        
        #pauseBtn {
            background: #ff9800;
            color: white;
        }
        
        #pauseBtn:hover {
            background: #e68900;
        }
        
        #resetBtn {
            background: #f44336;
            color: white;
        }
        
        #resetBtn:hover {
            background: #da190b;
        }
        
        .status {
            height: 20px;
            font-size: 0.9rem;
            color: #4CAF50;
            text-align: center;
        }
        
        .debug {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 0.9rem;
        }
        
        .explanation {
            margin-top: 20px;
        }
        
        .explanation h3 {
            color: #4cc9f0;
            margin-bottom: 10px;
        }
        
        .explanation ul {
            margin-left: 20px;
            line-height: 1.6;
        }
        
        .explanation li {
            margin-bottom: 8px;
        }
        
        .key-point {
            color: #4cc9f0;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>AI跳绳计数器检测原理</h1>
        
        <div class="content">
            <div class="left-panel">
                <div class="camera-container">
                    <canvas id="output" width="640" height="480"></canvas>
                    <video id="webcam" autoplay playsinline></video>
                </div>
                
                <div class="counter" id="counter">0</div>
                
                <div class="controls">
                    <button id="startBtn">开始</button>
                    <button id="pauseBtn">暂停</button>
                    <button id="resetBtn">重置</button>
                </div>
                
                <div class="status" id="status">准备就绪</div>
                
                <div class="debug" id="debug">
                    <div>肩膀高度: --</div>
                    <div>状态: --</div>
                    <div>连续跳动: --</div>
                    <div>帧计数: --</div>
                </div>
            </div>
            

        </div>
    </div>

    <script>
        // 全局变量
        let pose = null;
        let camera = null;
        let counter = 0;
        let isCounting = false;
        let jumpState = 'down';
        let lastShoulderPosition = 0;
        let jumpThreshold = 0.03; // 跳动检测阈值
        let consecutiveJumps = 0; // 连续跳动计数
        let frameCount = 0;
        
        // DOM元素
        const videoElement = document.getElementById('webcam');
        const canvasElement = document.getElementById('output');
        const canvasCtx = canvasElement.getContext('2d');
        const counterDisplay = document.getElementById('counter');
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const resetBtn = document.getElementById('resetBtn');
        const statusElement = document.getElementById('status');
        const debugElement = document.getElementById('debug');
        
        // 初始化函数
        function init() {
            // 创建Pose实例
            pose = new Pose({
                locateFile: (file) => {
                    console.log(file)
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
                }
            });
            
            pose.setOptions({
                modelComplexity: 1,
                smoothLandmarks: true,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });
            
            pose.onResults(onPoseResults);
            
            // 设置摄像头
            camera = new Camera(videoElement, {
                onFrame: async () => {
                    if (isCounting) {
                        await pose.send({image: videoElement});
                    }
                },
                width: 640,
                height: 480
            });
            
            // 按钮事件监听
            startBtn.addEventListener('click', startDetection);
            pauseBtn.addEventListener('click', pauseDetection);
            resetBtn.addEventListener('click', resetCounter);
            
            // 初始状态
            updateStatus('准备就绪');
        }
        
        // 姿态检测结果处理
        function onPoseResults(results) {
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
            
            if (results.poseLandmarks) {
                // 绘制关键点
                            drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {
                    color: '#FF0000',
                    lineWidth: 4
                });

                      drawLandmarks(canvasCtx, results.poseLandmarks, {
                    color: '#00FF00',
                    lineWidth: 2,
                    radius: 4
                });

                
                // 特别标注肩膀关键点
                const leftShoulder = results.poseLandmarks[11];
                const rightShoulder = results.poseLandmarks[12];
                
                if (leftShoulder && rightShoulder) {
                    // 绘制肩膀连线
                    canvasCtx.beginPath();
                    canvasCtx.moveTo(leftShoulder.x * canvasElement.width, leftShoulder.y * canvasElement.height);
                    canvasCtx.lineTo(rightShoulder.x * canvasElement.width, rightShoulder.y * canvasElement.height);
                    canvasCtx.strokeStyle = '#4cc9f0';
                    canvasCtx.lineWidth = 3;
                    canvasCtx.stroke();
                    
                    // 绘制肩膀点
                    canvasCtx.beginPath();
                    canvasCtx.arc(leftShoulder.x * canvasElement.width, leftShoulder.y * canvasElement.height, 6, 0, 2 * Math.PI);
                    canvasCtx.arc(rightShoulder.x * canvasElement.width, rightShoulder.y * canvasElement.height, 6, 0, 2 * Math.PI);
                    canvasCtx.fillStyle = '#4cc9f0';
                    canvasCtx.fill();
                }
                
                // 检测肩膀跳动
                detectShoulderJump(results.poseLandmarks);
            }
            
            canvasCtx.restore();
        }
        
        // 检测肩膀跳动
        function detectShoulderJump(landmarks) {
            frameCount++;
            
            // 获取肩膀关键点
            const leftShoulder = landmarks[11];
            const rightShoulder = landmarks[12];
            
            // 计算肩膀的平均高度
            const shoulderAvgY = (leftShoulder.y + rightShoulder.y) / 2;
            
            // 计算肩膀位置变化（当前帧 - 上一帧）
            const shoulderChange = shoulderAvgY - lastShoulderPosition;
            
            // 检测跳动状态变化
            if (shoulderChange < -jumpThreshold) { // 肩膀向上移动超过阈值
                if (jumpState === 'down') {
                    jumpState = 'up';
                    consecutiveJumps++;
                    
                    // 只有当连续检测到多次跳动时才计数，避免误判
                    if (consecutiveJumps >= 2) {
                        counter++;
                        counterDisplay.textContent = counter;
                        consecutiveJumps = 0; // 重置连续计数
                    }
                }
            } else if (shoulderChange > jumpThreshold) { // 肩膀向下移动超过阈值
                jumpState = 'down';
            }
            
            // 每10帧重置连续计数，防止状态卡住
            if (frameCount % 10 === 0) {
                consecutiveJumps = 0;
            }
            
            // 保存当前肩膀位置
            lastShoulderPosition = shoulderAvgY;
            
            // 更新调试信息
            updateDebugInfo(shoulderAvgY, shoulderChange);
        }
        
        // 更新调试信息
        function updateDebugInfo(shoulderAvgY, shoulderChange) {
            const debugLines = [
                `肩膀高度: ${shoulderAvgY.toFixed(3)}`,
                `位置变化: ${shoulderChange.toFixed(3)}`,
                `状态: ${jumpState}`,
                `连续跳动: ${consecutiveJumps}`,
                `帧计数: ${frameCount}`
            ];
            
            debugElement.innerHTML = debugLines.map(line => `<div>${line}</div>`).join('');
        }
        
        // 开始检测
        function startDetection() {
            if (!isCounting) {
                isCounting = true;
                camera.start();
                updateStatus('检测中...');
                // 重置状态变量
                jumpState = 'down';
                lastShoulderPosition = 0;
                consecutiveJumps = 0;
                frameCount = 0;
            }
        }
        
        // 暂停检测
        function pauseDetection() {
            if (isCounting) {
                isCounting = false;
                camera.stop();
                updateStatus('已暂停');
            }
        }
        
        // 重置计数器
        function resetCounter() {
            counter = 0;
            counterDisplay.textContent = counter;
            updateStatus('已重置');
            // 重置状态变量
            jumpState = 'down';
            lastShoulderPosition = 0;
            consecutiveJumps = 0;
            frameCount = 0;
        }
        
        // 更新状态显示
        function updateStatus(message) {
            statusElement.textContent = message;
        }
        
        // 页面加载完成后初始化
        window.addEventListener('load', init);
    </script>
</body>
</html>
